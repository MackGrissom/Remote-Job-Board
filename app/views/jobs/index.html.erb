<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Freely - Work Freely, Hire Globally</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        #map { width: 100%; height: 100%; }
        #job-listings {
            max-height: calc(100vh - 12rem);
            overflow-y: auto;
        }
        .job-marker-icon {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 30px;
            height: 30px;
            background-color: white;
            border-radius: 50%;
            border: 2px solid #ff9800; /* Changed to orange */
            font-size: 20px;
            position: relative;
        }
        .job-marker {
            line-height: 30px;
        }
        .custom-popup .leaflet-popup-content-wrapper {
            background-color: white;
            color: #333;
            border-radius: 8px;
            padding: 1px;
            box-shadow: 0 3px 14px rgba(0,0,0,0.4);
            border-left: 5px solid #ff9800; /* Added orange accent */
        }
        .custom-popup .leaflet-popup-content {
            margin: 13px 19px;
            line-height: 1.4;
        }
        .custom-popup .leaflet-popup-tip {
            background: white;
        }
        .apply-now-btn {
            background-color: #ff9800; /* Changed to orange */
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin: 4px 2px;
            cursor: pointer;
            border-radius: 4px;
            transition: background-color 0.3s;
        }
        .apply-now-btn:hover {
            background-color: #f57c00; /* Darker shade of orange for hover */
        }
        .job-tooltip {
            visibility: hidden;
            width: 200px;
            background-color: #555;
            color: #fff;
            text-align: center;
            border-radius: 6px;
            padding: 5px;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -100px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        .job-marker-icon:hover .job-tooltip {
            visibility: visible;
            opacity: 1;
        }
        .custom-popup {
            font-family: 'Arial', sans-serif;
            color: #333;
            max-width: 300px;
        }
        .custom-popup h3 {
            font-size: 18px;
            margin: 0 0 10px;
            color: #ff9800; /* Changed to orange */
        }
        .custom-popup p {
            margin: 5px 0;
            font-size: 14px;
            line-height: 1.4;
        }
        .custom-popup .job-detail {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
        }
        .custom-popup .job-detail-icon {
            width: 20px;
            margin-right: 10px;
            opacity: 0.7;
        }
        .apply-now-btn {
            background-color: #3498db;
            border: none;
            color: white;
            padding: 10px 20px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 16px;
            margin-top: 15px;
            cursor: pointer;
            border-radius: 5px;
            transition: background-color 0.3s;
        }
        .apply-now-btn:hover {
            background-color: #2980b9;
        }
        /* Update your existing styles */
        .industry-scroll-container {
            overflow-x: auto;
            overflow-y: hidden;
            padding: 10px 0;
            margin-bottom: 10px;
        }

        .industry-button-container {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .industry-filter-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            position: relative;
        }

        .industry-filter-btn:hover {
            background-color: #e5e7eb;
            transform: translateY(-2px);
        }

        .industry-filter-btn.selected {
            background-color: #fff5e6;
            border-color: #ff9800;
        }

        .industry-filter-btn .emoji {
            font-size: 1.5rem;
        }

        .industry-filter-btn:hover::after {
            content: attr(title);
        }

        .industry-scroll-container::-webkit-scrollbar {
            height: 6px;
        }

        .industry-scroll-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 3px;
        }

        .industry-scroll-container::-webkit-scrollbar-thumb {
            background-color: #ff9800;
            border-radius: 3px;
        }

        .industry-button-container {
            padding-bottom: 10px;
        }

        .industry-filter-btn {
            width: 60px;
            height: 60px;
            transition: all 0.3s ease;
        }

        .industry-filter-btn:hover {
            transform: translateY(-2px);
        }

        .industry-filter-btn.selected {
            background-color: #fff5e6;
            border-color: #ff9800;
        }

        .text-xxs {
            font-size: 0.625rem;
        }

        /* Add smooth scrolling behavior */
        .industry-scroll-container {
            scroll-behavior: smooth;
        }

        /* Add scroll indicators */
        .industry-scroll-wrapper {
            position: relative;
        }

        .scroll-indicator {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 20px;
            height: 20px;
            background-color: rgba(255, 152, 0, 0.8);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            cursor: pointer;
            z-index: 10;
        }

        .scroll-left {
            left: 5px;
        }

        .scroll-right {
            right: 5px;
        }

        .industry-filter-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 0.5rem;
            max-height: 150px; /* Reduced height */
            overflow-y: auto;
            padding-right: 0.5rem;
        }

        .industry-filter-btn {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            width: 100%;
            padding: 0.5rem 0.75rem; /* Reduced padding */
            background-color: #f3f4f6;
            border: 1px solid #e5e7eb;
            border-radius: 0.375rem; /* Slightly reduced border radius */
            transition: all 0.2s ease;
            cursor: pointer;
            overflow: hidden;
        }

        .industry-filter-btn:hover, .industry-filter-btn:focus {
            background-color: #fff;
            box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            transform: translateY(-1px);
        }

        .industry-filter-btn.selected {
            background-color: #fff5e6;
            border-color: #ff9800;
        }

        .industry-filter-btn .emoji {
            font-size: 1.25rem; /* Slightly reduced emoji size */
            margin-right: 0.5rem;
            flex-shrink: 0;
        }

        .industry-filter-btn .industry-name {
            font-size: 0.75rem; /* Reduced font size */
            font-weight: 500;
            color: #374151;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .industry-filter-container::-webkit-scrollbar {
            width: 4px; /* Reduced scrollbar width */
        }

        .industry-filter-container::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 2px;
        }

        .industry-filter-container::-webkit-scrollbar-thumb {
            background-color: #ff9800;
            border-radius: 2px;
        }

        @media (max-width: 640px) {
            .industry-filter-container {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }

        /* Custom styles for marker clusters */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background-color: rgba(255, 152, 0, 0.6);
        }
        .marker-cluster-small div,
        .marker-cluster-medium div,
        .marker-cluster-large div {
            background-color: rgba(255, 152, 0, 0.8);
        }
        .marker-cluster {
            background-clip: padding-box;
            border-radius: 20px;
        }
        .marker-cluster div {
            width: 30px;
            height: 30px;
            margin-left: 5px;
            margin-top: 5px;
            text-align: center;
            border-radius: 15px;
            font: 12px "Helvetica Neue", Arial, Helvetica, sans-serif;
            color: #fff;
        }
        .marker-cluster span {
            line-height: 30px;
        }
    </style>
</head>
<body class="flex flex-col h-screen bg-gray-100">
    
    <div class="flex h-full">
        <div class="w-1/2 flex flex-col bg-white shadow-lg">
            <div class="p-6 bg-gray-50 border-b border-gray-200">
                <% if user_signed_in? %>
                   
                <% end %>
                <h2 class="text-2xl font-bold mb-6 text-gray-800">Job Filters</h2>
                <%= form_with url: jobs_path, method: :get, local: false, id: 'job-filter-form', class: 'space-y-4' do |f| %>
                    <div>
                        <%= f.label :location, "Location", class: "block text-sm font-medium text-gray-700" %>
                        <%= f.select :location, ['North America', 'South America', 'Europe', 'Asia', 'Africa', 'Australia'], { include_blank: 'All Locations' }, class: "mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm rounded-md" %>
                    </div>
                    <div>
                        <%= f.label :industry, "Industry", class: "block text-sm font-medium text-gray-700 mb-2" %>
                        <%= f.select :industry, 
                          options_for_select(
                            industries.map { |industry, emoji| ["#{emoji} #{industry}", industry] },
                            params[:industry]
                          ),
                          { include_blank: "All Industries" },
                          { class: "mt-1 block w-full pl-3 pr-10 py-2 text-base border-gray-300 focus:outline-none focus:ring-orange-500 focus:border-orange-500 sm:text-sm rounded-md" }
                        %>
                    </div>
                <% end %>
            </div>
            <div id="job-listings" class="flex-1 overflow-y-auto p-6 space-y-6">
                <% @jobs.each do |job| %>
                  <div>
                    <h2><%= job.title %></h2>
                    <p><%= job.company %></p>
                    <%= link_to "See Details", job_path(job) %>
                  </div>
                <% end %>
            </div>
        </div>
        <div class="w-1/2 h-full">
            <div id="map" class="w-full h-full"></div>
        </div>
    </div>

    <%= javascript_tag do %>
      document.addEventListener('DOMContentLoaded', function() {
        const filterForm = document.getElementById('job-filter-form');
        const jobListings = document.getElementById('job-listings');
        const mapContainer = document.getElementById('map');
        let map;
        let markerClusterGroup;

        function initMap() {
          console.log('Initializing map...');
          if (!mapContainer) {
            console.error('Map container not found!');
            return;
          }

          mapContainer.style.height = '100%';

          map = L.map('map', {
            backgroundColor: '#ffffff',
            minZoom: 2,  // Add this line to set a minimum zoom level
            maxBounds: L.latLngBounds(L.latLng(-90, -180), L.latLng(90, 180))  // Add this line to restrict panning
          }).setView([20, 0], 3);  // Adjust the initial center and zoom level
          L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '¬© OpenStreetMap contributors',
            backgroundColor: '#ffffff',
            noWrap: true  // Add this line to prevent tile repetition
          }).addTo(map);

          console.log('Map initialized:', map);
          applyMapStyle('Default');

          markerClusterGroup = L.markerClusterGroup({
            maxClusterRadius: 80,
            iconCreateFunction: function(cluster) {
              var childCount = cluster.getChildCount();
              var c = ' marker-cluster-';
              if (childCount < 10) {
                c += 'small';
              } else if (childCount < 100) {
                c += 'medium';
              } else {
                c += 'large';
              }
              return new L.DivIcon({
                html: '<div><span>' + childCount + '</span></div>',
                className: 'marker-cluster' + c,
                iconSize: new L.Point(40, 40)
              });
            }
          });
        }

        function applyMapStyle(style) {
          console.log('Applying map style:', style);
          const styles = {
            'Default': 'grayscale(70%) invert(100%) contrast(90%) hue-rotate(180deg) saturate(80%) brightness(110%)',
            'Night Mode': 'invert(100%) hue-rotate(180deg) brightness(90%) contrast(90%)',
            'Sepia': 'sepia(100%) saturate(80%) brightness(80%)',
            'Cool Orange': 'hue-rotate(20deg) saturate(150%) brightness(100%)' // Changed to an orange-tinted style
          };
          if (map && map.getContainer()) {
            const mapPane = map.getPane('tilePane');
            if (mapPane) {
              mapPane.style.filter = styles[style] || styles['Default'];
            } else {
              console.error('Map tile pane not available for styling');
            }
          } else {
            console.error('Map or map container not available for styling');
          }
        }

        function fetchJobs(searchParams) {
          console.log('Fetching jobs with params:', searchParams.toString());
          fetch(`/jobs?${searchParams.toString()}`, {
            headers: {
              'Accept': 'application/json',
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => response.json())
          .then(data => {
            console.log('Received data:', data);
            if (data.job_listings_html) {
              jobListings.innerHTML = data.job_listings_html;
              console.log('Updated job listings');
            }
            if (data.job_coordinates && Array.isArray(data.job_coordinates)) {
              console.log('Updating map with', data.job_coordinates.length, 'jobs');
              updateMap(data.job_coordinates);
            }
          })
          .catch(error => {
            console.error('Error:', error);
            jobListings.innerHTML = '<p>Error loading job listings.</p>';
          });
        }

        function updateMap(jobCoordinates) {
          console.log('Updating map with job coordinates:', jobCoordinates);
          if (!map) {
            console.log('Map not initialized, initializing now...');
            initMap();
          }
          if (!map) {
            console.error('Failed to initialize map');
            return;
          }
          
          if (markerClusterGroup) {
            map.removeLayer(markerClusterGroup);
          }
          
          markerClusterGroup = L.markerClusterGroup();

          jobCoordinates.forEach((job, index) => {
            console.log(`Processing job ${index}:`, job);
            if (job && typeof job === 'object' && 'lat' in job && 'lng' in job) {
              const emoji = getEmojiForIndustry(job.industry);
              const salaryRange = getSalaryRange(job.salary_min, job.salary_max);
              const customIcon = L.divIcon({
                className: '',
                html: `
                  <div class="job-marker-icon" style="background-color: #fff5e6; border-color: #ff9800;">
                    <span class="job-marker">${emoji}</span>
                    <span class="job-tooltip" style="background-color: #ff9800; color: white;">
                      <strong>${job.title || `Job ${index + 1}`}</strong><br>
                      ${job.company || ''}<br>
                      ${job.location || ''}<br>
                      ${salaryRange}
                    </span>
                  </div>
                `,
                iconSize: [30, 30],
                iconAnchor: [15, 15]
              });

              const marker = L.marker([job.lat, job.lng], { icon: customIcon });
              console.log(`Added marker for job ${index} at [${job.lat}, ${job.lng}]`);
              
              const popupContent = `
                <div class="custom-popup">
                  <h3>${job.title || `Job ${index + 1}`}</h3>
                  ${job.company ? `
                    <div class="job-detail">
                      <img src="https://cdn-icons-png.flaticon.com/512/2910/2910791.png" alt="Company" class="job-detail-icon">
                      <p>${job.company}</p>
                    </div>
                  ` : ''}
                  ${job.location ? `
                    <div class="job-detail">
                      <img src="https://cdn-icons-png.flaticon.com/512/484/484167.png" alt="Location" class="job-detail-icon">
                      <p>${job.location}</p>
                    </div>
                  ` : ''}
                  ${salaryRange ? `
                    <div class="job-detail">
                      <img src="https://cdn-icons-png.flaticon.com/512/2830/2830284.png" alt="Salary" class="job-detail-icon">
                      <p>${salaryRange}</p>
                    </div>
                  ` : ''}
                  ${job.job_type ? `
                    <div class="job-detail">
                      <img src="https://cdn-icons-png.flaticon.com/512/3281/3281289.png" alt="Job Type" class="job-detail-icon">
                      <p>${job.job_type}</p>
                    </div>
                  ` : ''}
                  ${job.industry ? `
                    <div class="job-detail">
                      <img src="https://cdn-icons-png.flaticon.com/512/2910/2910791.png" alt="Industry" class="job-detail-icon">
                      <p>${job.industry}</p>
                    </div>
                  ` : ''}
                  <button class="apply-now-btn" onclick="applyForJob(${job.id})">Apply Now</button>
                </div>
              `;
              marker.bindPopup(popupContent);
              
              markerClusterGroup.addLayer(marker);
            } else {
              console.error(`Invalid job data at index ${index}:`, job);
            }
          });

          map.addLayer(markerClusterGroup);
          
          if (jobCoordinates.length > 0) {
            const validCoordinates = jobCoordinates.filter(job => job && typeof job === 'object' && 'lat' in job && 'lng' in job);
            if (validCoordinates.length > 0) {
              const bounds = markerClusterGroup.getBounds().pad(0.1);  // Add some padding
              map.fitBounds(bounds);
              console.log('Map bounds updated');
            }
          } else {
            map.setView([20, 0], 3);  // Reset to default view if no jobs
          }
        }

        function getEmojiForIndustry(industry) {
          const emojiMap = {
            'Accounting': 'üìä',
            'Advertising': 'üì¢',
            'Aerospace': '‚úàÔ∏è',
            'Agriculture': 'üåæ',
            'Automotive': 'üöó',
            'Banking': 'üè¶',
            'Biotechnology': 'üß¨',
            'Broadcasting': 'üì∫',
            'Business Services': 'üíº',
            'Chemicals': '‚öóÔ∏è',
            'Communications': 'üì°',
            'Construction': 'üèóÔ∏è',
            'Consulting': 'üó£Ô∏è',
            'Consumer Products': 'üõçÔ∏è',
            'Education': 'üéì',
            'Electronics': 'üîå',
            'Energy': '‚ö°',
            'Engineering': 'üõ†Ô∏è',
            'Entertainment': 'üé¨',
            'Environmental': 'üåø',
            'Fashion': 'üëó',
            'Finance': 'üí∞',
            'Food and Beverage': 'üçΩÔ∏è',
            'Government': 'üèõÔ∏è',
            'Healthcare': 'üè•',
            'Hospitality': 'üè®',
            'Insurance': 'üõ°Ô∏è',
            'Legal': '‚öñÔ∏è',
            'Logistics': 'üöö',
            'Manufacturing': 'üè≠',
            'Marketing': 'üìà',
            'Media': 'üì∞',
            'Mining': '‚õèÔ∏è',
            'Non-Profit': 'ü§ù',
            'Pharmaceuticals': 'üíä',
            'Public Relations': 'üóûÔ∏è',
            'Publishing': 'üìö',
            'Real Estate': 'üè†',
            'Retail': 'üõí',
            'Software': 'üíª',
            'Sports': '‚öΩ',
            'Technology': 'üîß',
            'Telecommunications': 'üìû',
            'Transportation': 'üöÜ',
            'Travel': '‚úàÔ∏è'
          };
          return emojiMap[industry] || 'üè¢';
        }

        function getSalaryRange(min, max) {
          if (min && max) {
            return `$${min.toLocaleString()} - $${max.toLocaleString()}`;
          } else if (min) {
            return `$${min.toLocaleString()}+`;
          } else if (max) {
            return `Up to $${max.toLocaleString()}`;
          } else {
            return 'Salary not specified';
          }
        }

        function createCustomIcon(emoji) {
          return L.divIcon({
            html: `<div class="job-marker-icon" style="background-color: #ff9800; color: white;"><span class="job-marker">${emoji}</span></div>`,
            className: '',
            iconSize: [30, 30],
            iconAnchor: [15, 15]
          });
        }

        filterForm.addEventListener('change', function(e) {
          console.log('Filter changed:', e.target.name, e.target.value);
          const formData = new FormData(filterForm);
          const searchParams = new URLSearchParams(formData);
          fetchJobs(searchParams);
        });

        fetchJobs(new URLSearchParams());

        initMap();
      });

      function applyForJob(jobId) {
        console.log(`Applying for job with ID: ${jobId}`);
        alert(`Application submitted for job ID: ${jobId}`);
      }

      document.addEventListener('DOMContentLoaded', function() {
        const scrollContainer = document.querySelector('.industry-scroll-container');
        const scrollContent = document.querySelector('.industry-button-container');
        
        // Add scroll indicators
        const scrollWrapper = document.createElement('div');
        scrollWrapper.className = 'industry-scroll-wrapper';
        scrollContainer.parentNode.insertBefore(scrollWrapper, scrollContainer);
        scrollWrapper.appendChild(scrollContainer);

        const leftIndicator = document.createElement('div');
        leftIndicator.className = 'scroll-indicator scroll-left';
        leftIndicator.innerHTML = '‚óÄ';
        scrollWrapper.appendChild(leftIndicator);

        const rightIndicator = document.createElement('div');
        rightIndicator.className = 'scroll-indicator scroll-right';
        rightIndicator.innerHTML = '‚ñ∂';
        scrollWrapper.appendChild(rightIndicator);

        // Scroll functions
        leftIndicator.addEventListener('click', () => {
          scrollContainer.scrollBy({ left: -200, behavior: 'smooth' });
        });

        rightIndicator.addEventListener('click', () => {
          scrollContainer.scrollBy({ left: 200, behavior: 'smooth' });
        });

        // Show/hide indicators based on scroll position
        function updateIndicators() {
          leftIndicator.style.display = scrollContainer.scrollLeft > 0 ? 'flex' : 'none';
          rightIndicator.style.display = 
            scrollContainer.scrollLeft < scrollContent.offsetWidth - scrollContainer.offsetWidth ? 'flex' : 'none';
        }

        scrollContainer.addEventListener('scroll', updateIndicators);
        window.addEventListener('resize', updateIndicators);
        updateIndicators();
      });

      document.addEventListener('DOMContentLoaded', function() {
        const locationButtons = document.querySelectorAll('.location-filter-btn');
        const locationFilterInput = document.getElementById('location-filter');

        locationButtons.forEach(button => {
          button.addEventListener('click', function() {
            locationButtons.forEach(btn => btn.classList.remove('selected'));
            this.classList.add('selected');
            locationFilterInput.value = this.dataset.location;
            updateFilters();
          });
        });

        function updateFilters() {
          const formData = new FormData(document.getElementById('job-filter-form'));
          const searchParams = new URLSearchParams(formData);
          fetchJobs(searchParams);
        }
      });
    <% end %>
</body>
</html>
